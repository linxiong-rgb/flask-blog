{% extends "base.html" %}

{% block title %}{{ post.title }} - æˆ‘çš„åšå®¢{% endblock %}

{% block description %}{{ post.summary or post.title }} - {{ post.content | striptags | truncate(150) }}{% endblock %}

{% block keywords %}{{ post.title }}{% if post.tags %},{% for tag in post.tags %}{{ tag.name }}{% if not loop.last %},{% endif %}{% endfor %}{% endif %}{% endblock %}

{% block og_type %}article{% endblock %}
{% block og_url %}{{ request.url_root }}post/{{ post.id }}{% endblock %}
{% block og_title %}{{ post.title }}{% endblock %}
{% block og_description %}{{ post.summary or post.content | striptags | truncate(150) }}{% endblock %}
{% block og_image %}{% if post.cover_image %}{{ post.cover_image }}{% else %}{{ url_for('static', filename='img/default-og.png', _external=True) }}{% endif %}{% endblock %}

{% block twitter_title %}{{ post.title }}{% endblock %}
{% block twitter_description %}{{ post.summary or post.content | striptags | truncate(150) }}{% endblock %}
{% block twitter_image %}{% if post.cover_image %}{{ post.cover_image }}{% else %}{{ url_for('static', filename='img/default-og.png', _external=True) }}{% endif %}{% endblock %}

{% block canonical %}{{ request.url_root }}post/{{ post.id }}{% endblock %}

{% block content %}
<!-- é˜…è¯»è¿›åº¦æ¡ -->
<div class="reading-progress" id="readingProgress"></div>

<div class="typora-container">
    <div class="article-wrapper">
        <!-- å·¦ä¾§ç›®å½• -->
        <aside class="article-toc" id="toc">
            <div class="toc-header">
                <span class="toc-title">
                    <i class="bi bi-list-ul"></i> ç›®å½•
                </span>
                <button class="toc-toggle" id="tocToggle" title="åˆ‡æ¢ç›®å½•">
                    <i class="bi bi-chevron-left"></i>
                </button>
            </div>
            <div class="toc-content" id="tocContent">
                <div class="toc-loading">æ­£åœ¨ç”Ÿæˆç›®å½•...</div>
            </div>
        </aside>

        <!-- ä¸»æ–‡ç« åŒºåŸŸ -->
        <article class="typora-article">
            <!-- ç®€åŒ–çš„é¢åŒ…å±‘å¯¼èˆª -->
            <nav class="typora-breadcrumb">
                <a href="{{ url_for('main.index') }}">é¦–é¡µ</a>
                {% if post.category %}
                    <span class="separator">/</span>
                    <a href="{{ url_for('main.category', category_id=post.category.id) }}">{{ post.category.name }}</a>
                {% endif %}
                <span class="separator">/</span>
                <span class="current">{{ post.title }}</span>
            </nav>

            <!-- Typora é£æ ¼çš„æ–‡ç« å¤´éƒ¨ -->
            <header class="typora-header">
                <h1 class="typora-title">{{ post.title }}</h1>

                <div class="typora-meta">
                    <span class="meta-item">
                        <i class="bi bi-person"></i> {{ post.author.username }}
                    </span>
                    <span class="separator">Â·</span>
                    <span class="meta-item">
                        <i class="bi bi-calendar"></i> {{ post.created_at.strftime('%Y-%m-%d') }}
                    </span>
                    {% if post.updated_at != post.created_at %}
                        <span class="separator">Â·</span>
                        <span class="meta-item">
                            æ›´æ–°äº {{ post.updated_at.strftime('%Y-%m-%d') }}
                        </span>
                    {% endif %}
                    <span class="separator">Â·</span>
                    <span class="meta-item">
                        <i class="bi bi-eye"></i> {{ post.views }}
                    </span>
                </div>

                {% if post.tags %}
                    <div class="typora-tags">
                        {% for tag in post.tags %}
                            <a href="{{ url_for('main.tag', tag_id=tag.id) }}" class="tag-link">#{{ tag.name }}</a>
                        {% endfor %}
                    </div>
                {% endif %}
            </header>

            <!-- å°é¢å›¾ -->
            {% if post.cover_image %}
                <div class="typora-cover">
                    <img
                        src="{{ post.cover_image }}"
                        alt="{{ post.title }}"
                        loading="lazy"
                        decoding="async"
                        class="lazy-image"
                        onerror="this.onerror=null; this.src='{{ url_for('static', filename='img/default-og.png') }}'; this.classList.add('image-error');"
                        onload="this.classList.add('image-loaded');">
                </div>
            {% endif %}

            <!-- Typora é£æ ¼çš„æ–‡ç« å†…å®¹ -->
            <div class="typora-content" id="articleContent">
                {{ post.content_html | safe }}
            </div>

            <!-- æ–‡ç« æ“ä½œæŒ‰é’®åŒºåŸŸ -->
            <div class="article-bookmark-section">
                <div class="article-actions-wrapper">
                    <!-- åˆ†äº«æŒ‰é’®ç»„ -->
                    <div class="share-buttons-group">
                        <button class="action-icon-btn" data-platform="weibo" onclick="shareToWeibo()" title="åˆ†äº«åˆ°å¾®åš">
                            <i class="bi bi-sina-weibo"></i>
                        </button>
                        <button class="action-icon-btn" data-platform="qq" onclick="shareToQQ()" title="åˆ†äº«åˆ°QQ">
                            <span class="penguin-icon">ğŸ§</span>
                        </button>
                        <button class="action-icon-btn" data-platform="wechat" onclick="shareToWechat()" title="åˆ†äº«åˆ°å¾®ä¿¡">
                            <i class="bi bi-wechat"></i>
                        </button>
                        <button class="action-icon-btn" data-platform="copy" onclick="copyArticleLink()" title="å¤åˆ¶é“¾æ¥">
                            <i class="bi bi-link"></i>
                        </button>
                    </div>

                    <!-- æ”¶è—æŒ‰é’® -->
                    <button class="bookmark-action-btn" id="bookmarkBtn" onclick="toggleBookmark()">
                        <i class="bi bi-bookmark" id="bookmarkIcon"></i>
                        <span class="bookmark-text" id="bookmarkText">æ”¶è—</span>
                        <span class="bookmark-count-badge" id="bookmarkCount">{{ post.bookmarks.count() if post.bookmarks else 0 }}</span>
                    </button>
                </div>
                <!-- æ“ä½œæç¤º -->
                <div class="action-feedback" id="actionFeedback"></div>
            </div>

            <!-- æ–‡ç« åº•éƒ¨æ“ä½œæ  -->
            <footer class="typora-footer">
                <div class="footer-actions">
                    <a href="{{ url_for('main.index') }}" class="action-btn">
                        <i class="bi bi-arrow-left"></i> è¿”å›é¦–é¡µ
                    </a>

                    <div class="export-buttons">
                        <a href="/export/markdown/{{ post.id }}" class="action-btn export-btn">
                            <i class="bi bi-markdown"></i> å¯¼å‡º Markdown
                        </a>
                        <a href="/export/pdf/{{ post.id }}" class="action-btn export-btn">
                            <i class="bi bi-file-pdf"></i> å¯¼å‡º HTML
                        </a>
                    </div>

                    {% if current_user.is_authenticated and post.author == current_user %}
                        <a href="{{ url_for('admin.edit_post', post_id=post.id) }}" class="action-btn edit-btn">
                            <i class="bi bi-pencil"></i> ç¼–è¾‘
                        </a>
                    {% endif %}
                </div>
            </footer>

            <!-- ç›¸å…³æ–‡ç« æ¨è -->
            {% if related_posts %}
            <div class="related-posts-section mt-5">
                <h6 class="mb-3">
                    <i class="bi bi-collection"></i> ç›¸å…³æ–‡ç« æ¨è
                </h6>
                <div class="row">
                    {% for related_post in related_posts %}
                    <div class="col-md-6 mb-3">
                        <a href="{{ url_for('main.post', post_id=related_post.id) }}" class="related-post-card">
                            {% if related_post.cover_image %}
                            <div class="related-post-img">
                                <img src="{{ related_post.cover_image }}" alt="{{ related_post.title }}" loading="lazy">
                            </div>
                            {% endif %}
                            <div class="related-post-content">
                                <h6 class="related-post-title">{{ related_post.title }}</h6>
                                <div class="related-post-meta">
                                    {% if related_post.category %}
                                    <span class="badge-category">{{ related_post.category.name }}</span>
                                    {% endif %}
                                    <span class="text-muted small">
                                        <i class="bi bi-calendar3"></i> {{ related_post.created_at.strftime('%Y-%m-%d') }}
                                    </span>
                                </div>
                            </div>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </article>
    </div>
</div>

<!-- å›é¡¶éƒ¨æŒ‰é’® -->
<button class="back-to-top" id="backToTop" title="è¿”å›é¡¶éƒ¨">
    <i class="bi bi-arrow-up"></i>
</button>

<!-- ä¸ªäººä¿¡æ¯æ¨¡æ€æ¡† -->
<div class="modal fade" id="authorModal" tabindex="-1" aria-labelledby="authorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="authorModalLabel">
                    <i class="bi bi-person-circle"></i> å…³äºä½œè€…
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="author-info">
                    <div class="author-avatar">
                        <i class="bi bi-person-circle"></i>
                    </div>
                    <h4>{{ post.author.username }}</h4>
                    <div class="author-details">
                        <p>
                            <i class="bi bi-envelope"></i>
                            <a href="mailto:3497875641@qq.com">3497875641@qq.com</a>
                        </p>
                        <p class="author-bio">çƒ­çˆ±æŠ€æœ¯ï¼Œä¸“æ³¨äºç½‘ç»œå®‰å…¨ä¸æ¸—é€æµ‹è¯•é¢†åŸŸ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// å›é¡¶éƒ¨åŠŸèƒ½
const backToTopBtn = document.getElementById('backToTop');

window.addEventListener('scroll', () => {
    if (window.pageYOffset > 300) {
        backToTopBtn.classList.add('show');
    } else {
        backToTopBtn.classList.remove('show');
    }
});

backToTopBtn.addEventListener('click', () => {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
});

// ç›®å½•åŠŸèƒ½
const tocToggle = document.getElementById('tocToggle');
const tocPanel = document.getElementById('toc');
const tocContent = document.getElementById('tocContent');

tocToggle.addEventListener('click', () => {
    tocPanel.classList.toggle('collapsed');
    const icon = tocToggle.querySelector('i');
    if (tocPanel.classList.contains('collapsed')) {
        icon.classList.remove('bi-chevron-left');
        icon.classList.add('bi-chevron-right');
    } else {
        icon.classList.remove('bi-chevron-right');
        icon.classList.add('bi-chevron-left');
    }
});

// ç”Ÿæˆç›®å½•
function generateTOC() {
    const content = document.getElementById('articleContent');
    const headings = content.querySelectorAll('h1, h2, h3, h4, h5, h6');

    if (headings.length === 0) {
        tocContent.innerHTML = '<div class="toc-empty">æš‚æ— ç›®å½•</div>';
        return;
    }

    // æ¸…ç†æ ‡é¢˜æ–‡æœ¬ï¼Œç§»é™¤æ•°å­—å‰ç¼€
    function cleanHeadingText(text) {
        return text
            .replace(/^[\d]+\.\s*/, '')  // ç§»é™¤ "1. " ç­‰æ•°å­—å‰ç¼€
            .replace(/^æµç¨‹\d+[ï¼š:]\s*/, '')  // ç§»é™¤ "æµç¨‹1ï¼š" ç­‰
            .replace(/^[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+[ã€ï¼]\s*/, '')  // ç§»é™¤ä¸­æ–‡æ•°å­—å‰ç¼€
            .trim();
    }

    // æ„å»ºåµŒå¥—ç»“æ„çš„ç›®å½•
    const tocStructure = [];
    const stack = [];

    headings.forEach((heading, index) => {
        const headingLevel = parseInt(heading.tagName.substring(1));
        const headingText = cleanHeadingText(heading.textContent.trim());
        const headingId = 'heading-' + index;

        heading.id = headingId;

        const item = {
            level: headingLevel,
            text: headingText,
            id: headingId,
            children: []
        };

        // æ‰¾åˆ°åˆé€‚çš„çˆ¶çº§
        while (stack.length > 0 && stack[stack.length - 1].level >= headingLevel) {
            stack.pop();
        }

        if (stack.length === 0) {
            tocStructure.push(item);
        } else {
            stack[stack.length - 1].children.push(item);
        }

        stack.push(item);
    });

    // æ¸²æŸ“ç›®å½•HTML
    function renderTOC(items) {
        if (!items || items.length === 0) return '';

        let html = '<ul class="toc-list">';
        items.forEach(item => {
            html += `
                <li class="toc-item toc-level-${item.level}">
                    <a href="#${item.id}" class="toc-link" data-target="${item.id}">
                        ${item.text}
                    </a>
                    ${renderTOC(item.children)}
                </li>
            `;
        });
        html += '</ul>';
        return html;
    }

    tocContent.innerHTML = renderTOC(tocStructure);

    // ç›®å½•ç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.toc-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const targetId = link.getAttribute('data-target');
            const targetElement = document.getElementById(targetId);

            if (targetElement) {
                const navbarHeight = document.querySelector('.navbar').offsetHeight;
                const offsetTop = targetElement.offsetTop - navbarHeight - 20;

                window.scrollTo({
                    top: offsetTop,
                    behavior: 'smooth'
                });

                // æ›´æ–°æ´»åŠ¨çŠ¶æ€
                document.querySelectorAll('.toc-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
            }
        });
    });
}

// é¡µé¢åŠ è½½åç”Ÿæˆç›®å½•
document.addEventListener('DOMContentLoaded', () => {
    generateTOC();

    // æ»šåŠ¨æ—¶é«˜äº®å½“å‰ç›®å½•é¡¹
    const headings = document.querySelectorAll('#articleContent h1, #articleContent h2, #articleContent h3');
    const tocLinks = document.querySelectorAll('.toc-link');

    window.addEventListener('scroll', () => {
        const navbarHeight = document.querySelector('.navbar').offsetHeight;
        const scrollPosition = window.scrollY + navbarHeight + 100;
        let currentHeading = null;

        headings.forEach(heading => {
            const headingTop = heading.offsetTop;
            if (scrollPosition >= headingTop) {
                currentHeading = heading;
            }
        });

        if (currentHeading) {
            tocLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-target') === currentHeading.id) {
                    link.classList.add('active');
                }
            });
        } else {
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å½“å‰æ ‡é¢˜ï¼Œæ¸…é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
            tocLinks.forEach(link => link.classList.remove('active'));
        }
    });
});

// ä»£ç å—å¤åˆ¶åŠŸèƒ½å’Œè¯­è¨€è¯†åˆ«
function addCopyButtons() {
    const codeBlocks = document.querySelectorAll('pre code');

    codeBlocks.forEach((codeBlock, index) => {
        const pre = codeBlock.parentElement;

        // è¯†åˆ«ä»£ç è¯­è¨€
        let language = 'CODE';
        const classList = Array.from(codeBlock.classList);
        for (const cls of classList) {
            if (cls.startsWith('language-')) {
                language = cls.replace('language-', '').toUpperCase();
                break;
            }
        }

        // ä¸º .codehilite å®¹å™¨æ·»åŠ è¯­è¨€æ ‡ç­¾
        if (pre.classList.contains('codehilite') || pre.parentElement?.classList.contains('codehilite')) {
            const hiliteContainer = pre.classList.contains('codehilite') ? pre : pre.parentElement;
            hiliteContainer.setAttribute('data-language', language);
        }

        // åˆ›å»ºå¤åˆ¶æŒ‰é’®
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-button';
        copyBtn.innerHTML = '<i class="bi bi-clipboard"></i>';
        copyBtn.title = 'å¤åˆ¶ä»£ç ';
        copyBtn.dataset.index = index;

        // æ·»åŠ æŒ‰é’®åˆ°ä»£ç å—
        pre.style.position = 'relative';
        pre.appendChild(copyBtn);

        // å¤åˆ¶äº‹ä»¶
        copyBtn.addEventListener('click', async () => {
            const code = codeBlock.textContent;

            try {
                await navigator.clipboard.writeText(code);
                copyBtn.innerHTML = '<i class="bi bi-check"></i>';
                copyBtn.classList.add('copied');

                setTimeout(() => {
                    copyBtn.innerHTML = '<i class="bi bi-clipboard"></i>';
                    copyBtn.classList.remove('copied');
                }, 2000);
            } catch (err) {
                // é™çº§æ–¹æ¡ˆ
                const textarea = document.createElement('textarea');
                textarea.value = code;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();

                try {
                    document.execCommand('copy');
                    copyBtn.innerHTML = '<i class="bi bi-check"></i>';
                    copyBtn.classList.add('copied');

                    setTimeout(() => {
                        copyBtn.innerHTML = '<i class="bi bi-clipboard"></i>';
                        copyBtn.classList.remove('copied');
                    }, 2000);
                } catch (e) {
                    copyBtn.innerHTML = '<i class="bi bi-x"></i>';
                    copyBtn.classList.add('error');
                }

                document.body.removeChild(textarea);
            }
        });
    });
}

// é¡µé¢åŠ è½½å®Œæˆåæ·»åŠ å¤åˆ¶æŒ‰é’®
document.addEventListener('DOMContentLoaded', addCopyButtons);

// å›¾ç‰‡æ‡’åŠ è½½
document.addEventListener('DOMContentLoaded', function() {
    const images = document.querySelectorAll('.typora-content img');

    const imageObserver = new IntersectionObserver(function(entries, observer) {
        entries.forEach(function(entry) {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.classList.add('loaded');
                observer.unobserve(img);
            }
        });
    });

    images.forEach(function(img) {
        img.setAttribute('loading', 'lazy');
        imageObserver.observe(img);
    });

    // åˆå§‹åŒ–é˜…è¯»è¿›åº¦æ¡
    initReadingProgress();
});

// ========================================
// é˜…è¯»è¿›åº¦æ¡åŠŸèƒ½
// ========================================

function initReadingProgress() {
    const progressBar = document.getElementById('readingProgress');
    const articleContent = document.getElementById('articleContent');

    if (!progressBar || !articleContent) return;

    window.addEventListener('scroll', function() {
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight - windowHeight;
        const scrolled = window.scrollY;
        const progress = (scrolled / documentHeight) * 100;

        progressBar.style.width = Math.min(progress, 100) + '%';

        // é˜…è¯»å®Œæˆæ—¶æ·»åŠ å®Œæˆæ ·å¼
        if (progress >= 100) {
            progressBar.classList.add('complete');
        } else {
            progressBar.classList.remove('complete');
        }
    });
}

// ========================================
// æ–‡ç« æ”¶è—åŠŸèƒ½
// ========================================

const postId = {{ post.id }};
let isBookmarked = false; // å½“å‰ç”¨æˆ·æ˜¯å¦å·²æ”¶è—
let bookmarkCount = 0; // å½“å‰æ”¶è—æ•°

// åˆå§‹åŒ–æ”¶è—çŠ¶æ€
document.addEventListener('DOMContentLoaded', function() {
    initBookmarkButton();
});

function initBookmarkButton() {
    const bookmarkBtn = document.getElementById('bookmarkBtn');
    const bookmarkIcon = document.getElementById('bookmarkIcon');
    const bookmarkCountEl = document.getElementById('bookmarkCount');

    if (!bookmarkBtn || !bookmarkIcon || !bookmarkCountEl) return;

    // è·å–æ”¶è—çŠ¶æ€
    fetchBookmarkStatus();
}

async function fetchBookmarkStatus() {
    try {
        const response = await fetch(`/api/post/${postId}/bookmarks`);
        const data = await response.json();
        bookmarkCount = data.bookmark_count;
        isBookmarked = data.bookmarked;
        updateBookmarkUI();
    } catch (error) {
        console.error('è·å–æ”¶è—çŠ¶æ€å¤±è´¥:', error);
    }
}

async function toggleBookmark() {
    if (!{{ current_user.is_authenticated|tojson }}) {
        showActionFeedback('è¯·å…ˆç™»å½•åæ”¶è—');
        return;
    }

    try {
        const response = await fetch(`/api/post/${postId}/bookmark`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        });

        if (response.ok) {
            const data = await response.json();
            isBookmarked = data.bookmarked;
            bookmarkCount = data.bookmark_count;
            updateBookmarkUI();

            // æ˜¾ç¤ºæ–‡å­—æç¤º
            if (isBookmarked) {
                showActionFeedback('âœ“ æ”¶è—æˆåŠŸï¼');
            } else {
                showActionFeedback('âœ“ å·²å–æ¶ˆæ”¶è—');
            }
        } else {
            // å°è¯•è¯»å–é”™è¯¯ä¿¡æ¯
            let errorMsg = 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•';
            try {
                const errorData = await response.json();
                if (errorData.message) {
                    errorMsg = errorData.message;
                }
            } catch (e) {
                console.error('Response not JSON:', response.status);
            }
            showActionFeedback(errorMsg);
        }
    } catch (error) {
        console.error('æ”¶è—æ“ä½œå¤±è´¥:', error);
        showActionFeedback('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
    }
}

function updateBookmarkUI() {
    const bookmarkBtn = document.getElementById('bookmarkBtn');
    const bookmarkIcon = document.getElementById('bookmarkIcon');
    const bookmarkText = document.getElementById('bookmarkText');
    const bookmarkCountEl = document.getElementById('bookmarkCount');

    if (bookmarkIcon) {
        bookmarkIcon.classList.toggle('bi-bookmark-fill', isBookmarked);
        bookmarkIcon.classList.toggle('bi-bookmark', !isBookmarked);
    }

    if (bookmarkBtn) {
        bookmarkBtn.classList.toggle('active', isBookmarked);
    }

    if (bookmarkText) {
        bookmarkText.textContent = isBookmarked ? 'å·²æ”¶è—' : 'æ”¶è—';
    }

    if (bookmarkCountEl) {
        bookmarkCountEl.textContent = bookmarkCount;
    }
}

function showActionFeedback(message) {
    const feedback = document.getElementById('actionFeedback');
    if (feedback) {
        feedback.textContent = message;
        feedback.classList.add('show');
        setTimeout(() => {
            feedback.classList.remove('show');
        }, 2000);
    }
}

// åˆ†äº«åŠŸèƒ½
function getArticleUrl() {
    return window.location.href;
}

function getArticleTitle() {
    const titleElement = document.querySelector('.typora-title');
    return titleElement ? titleElement.textContent : document.title;
}

function shareToWeibo() {
    const url = encodeURIComponent(getArticleUrl());
    const title = encodeURIComponent(getArticleTitle());
    window.open(`https://service.weibo.com/share/share.php?url=${url}&title=${title}`, '_blank');
    showActionFeedback('æ­£åœ¨æ‰“å¼€å¾®åšåˆ†äº«...');
}

function shareToQQ() {
    const url = encodeURIComponent(getArticleUrl());
    const title = encodeURIComponent(getArticleTitle());
    window.open(`https://connect.qq.com/widget/shareqq/index.html?url=${url}&title=${title}`, '_blank');
    showActionFeedback('æ­£åœ¨æ‰“å¼€QQåˆ†äº«...');
}

function shareToWechat() {
    showActionFeedback('è¯·ä½¿ç”¨å¾®ä¿¡æ‰«ä¸€æ‰«åŠŸèƒ½æ‰«æå±å¹•äºŒç»´ç åˆ†äº«');
}

function copyArticleLink() {
    const url = getArticleUrl();

    // ä½¿ç”¨ç°ä»£ API
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url).then(function() {
            showActionFeedback('âœ“ é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        }).catch(function() {
            fallbackCopyLink(url);
        });
    } else {
        fallbackCopyLink(url);
    }
}

function fallbackCopyLink(text) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();

    try {
        document.execCommand('copy');
        showActionFeedback('âœ“ é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
    } catch (e) {
        showActionFeedback('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥');
    }

    document.body.removeChild(textarea);
}

// ========================================
// å›¾ç‰‡æ‡’åŠ è½½ä¼˜åŒ–
// ========================================

// ä¸ºæ–‡ç« å†…å®¹ä¸­çš„æ‰€æœ‰å›¾ç‰‡æ·»åŠ æ‡’åŠ è½½å’Œé”™è¯¯å¤„ç†
function optimizeImages() {
    const images = document.querySelectorAll('#articleContent img, .typora-content img, article img');

    images.forEach(img => {
        // å¦‚æœå·²ç»æœ‰ loading å±æ€§åˆ™è·³è¿‡
        if (img.hasAttribute('data-loading-optimized')) {
            return;
        }
        img.setAttribute('data-loading-optimized', 'true');

        // æ·»åŠ æ‡’åŠ è½½å±æ€§
        if (!img.hasAttribute('loading')) {
            img.setAttribute('loading', 'lazy');
        }

        // æ·»åŠ å¼‚æ­¥è§£ç å±æ€§
        if (!img.hasAttribute('decoding')) {
            img.setAttribute('decoding', 'async');
        }

        // æ·»åŠ åŠ è½½ç±»
        img.classList.add('lazy-image');

        // åŠ è½½å®Œæˆå¤„ç†
        img.addEventListener('load', function() {
            this.classList.add('image-loaded');
            this.classList.remove('lazy-image');
        });

        // é”™è¯¯å¤„ç† - å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºé»˜è®¤å›¾ç‰‡
        img.addEventListener('error', function() {
            // åªå¤„ç†ä¸€æ¬¡é”™è¯¯ï¼Œé¿å…æ— é™å¾ªç¯
            if (!this.hasAttribute('data-error-handled')) {
                this.setAttribute('data-error-handled', 'true');
                this.classList.add('image-error');
                this.classList.remove('lazy-image');

                // è®¾ç½®é»˜è®¤å›¾ç‰‡
                const defaultImg = "{{ url_for('static', filename='img/default-og.png') }}";
                if (this.src !== defaultImg) {
                    this.src = defaultImg;
                    this.alt = "å›¾ç‰‡åŠ è½½å¤±è´¥";
                }
            }
        });
    });
}

// é¡µé¢åŠ è½½å®Œæˆåä¼˜åŒ–å›¾ç‰‡
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', optimizeImages);
} else {
    optimizeImages();
}

// ä¸ºç›¸å…³æ–‡ç« çš„å›¾ç‰‡ä¹Ÿæ·»åŠ ä¼˜åŒ–
const relatedImages = document.querySelectorAll('.related-post-img img');
relatedImages.forEach(img => {
    if (!img.hasAttribute('loading')) {
        img.setAttribute('loading', 'lazy');
    }
    if (!img.hasAttribute('decoding')) {
        img.setAttribute('decoding', 'async');
    }
    img.classList.add('lazy-image');
    img.addEventListener('load', function() {
        this.classList.add('image-loaded');
    });
});

// å›¾ç‰‡å ä½ç¬¦åŠŸèƒ½
function createImagePlaceholder(container) {
    const placeholder = document.createElement('div');
    placeholder.className = 'image-placeholder';
    placeholder.innerHTML = '<div class="image-loading-indicator"><i class="bi bi-hourglass-split"></i> åŠ è½½ä¸­...</div>';
    return placeholder;
}

// å›¾ç‰‡æ¸è¿›å¼åŠ è½½ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
function enableProgressiveLoading() {
    const images = document.querySelectorAll('img[data-src]');

    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                const src = img.getAttribute('data-src');

                if (src) {
                    // å…ˆåŠ è½½ä½è´¨é‡å ä½å›¾
                    if (img.hasAttribute('data-src-low')) {
                        img.src = img.getAttribute('data-src-low');
                    }

                    // ç„¶ååŠ è½½é«˜è´¨é‡å›¾ç‰‡
                    const highQualityImg = new Image();
                    highQualityImg.src = src;
                    highQualityImg.onload = function() {
                        img.src = src;
                        img.classList.add('image-loaded');
                    };

                    observer.unobserve(img);
                }
            }
        });
    }, {
        rootMargin: '50px',
        threshold: 0.01
    });

    images.forEach(img => imageObserver.observe(img));
}

// å¯ç”¨æ¸è¿›å¼åŠ è½½ï¼ˆå¦‚æœéœ€è¦ï¼‰
// enableProgressiveLoading();

// ========================================
// å›¾ç‰‡ç¯ç®±åŠŸèƒ½
// ========================================

// åˆ›å»ºç¯ç®± HTML ç»“æ„
function createLightbox() {
    const lightboxHTML = `
        <div id="imageLightbox" class="lightbox" style="display: none;">
            <div class="lightbox-overlay" onclick="closeLightbox()"></div>
            <div class="lightbox-content">
                <button class="lightbox-close" onclick="closeLightbox()" title="å…³é—­">
                    <i class="bi bi-x-lg"></i>
                </button>
                <button class="lightbox-prev" onclick="showPrevImage()" title="ä¸Šä¸€å¼ ">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <button class="lightbox-next" onclick="showNextImage()" title="ä¸‹ä¸€å¼ ">
                    <i class="bi bi-chevron-right"></i>
                </button>
                <img id="lightboxImage" src="" alt="" class="lightbox-img">
                <div class="lightbox-caption" id="lightboxCaption"></div>
                <div class="lightbox-counter" id="lightboxCounter"></div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', lightboxHTML);
}

// ç¯ç®±ç›¸å…³å˜é‡
let currentImageIndex = 0;
let lightboxImages = [];

// åˆå§‹åŒ–å›¾ç‰‡ç¯ç®±
function initLightbox() {
    createLightbox();

    // ä¸ºæ‰€æœ‰å¯æŸ¥çœ‹çš„å›¾ç‰‡æ·»åŠ ç‚¹å‡»äº‹ä»¶
    const images = document.querySelectorAll('#articleContent img, .typora-content img, .typora-cover img');

    images.forEach((img, index) => {
        if (!img.hasAttribute('data-lightbox-enabled')) {
            img.setAttribute('data-lightbox-enabled', 'true');
            img.style.cursor = 'pointer';
            img.addEventListener('click', (e) => openLightbox(e, img, images));
        }
    });
}

// æ‰“å¼€ç¯ç®±
function openLightbox(event, clickedImg, allImages) {
    event.preventDefault();
    event.stopPropagation();

    // æ”¶é›†æ‰€æœ‰å›¾ç‰‡
    lightboxImages = Array.from(allImages).filter(img => img.src && !img.src.includes('default-og.png'));

    // æ‰¾åˆ°å½“å‰ç‚¹å‡»çš„å›¾ç‰‡ç´¢å¼•
    currentImageIndex = lightboxImages.findIndex(img => img === clickedImg);

    if (currentImageIndex === -1) {
        currentImageIndex = 0;
    }

    // æ˜¾ç¤ºå½“å‰å›¾ç‰‡
    showCurrentImage();

    // æ˜¾ç¤ºç¯ç®±
    const lightbox = document.getElementById('imageLightbox');
    lightbox.style.display = 'flex';
    document.body.style.overflow = 'hidden';

    // æ·»åŠ é”®ç›˜äº‹ä»¶
    document.addEventListener('keydown', handleLightboxKeyboard);
}

// å…³é—­ç¯ç®±
function closeLightbox() {
    const lightbox = document.getElementById('imageLightbox');
    lightbox.style.display = 'none';
    document.body.style.overflow = '';
    document.removeEventListener('keydown', handleLightboxKeyboard);
}

// æ˜¾ç¤ºå½“å‰å›¾ç‰‡
function showCurrentImage() {
    if (lightboxImages.length === 0) return;

    const img = lightboxImages[currentImageIndex];
    const lightboxImg = document.getElementById('lightboxImage');
    const caption = document.getElementById('lightboxCaption');
    const counter = document.getElementById('lightboxCounter');

    // è®¾ç½®å›¾ç‰‡æº
    lightboxImg.src = img.src;
    lightboxImg.alt = img.alt || 'å›¾ç‰‡';

    // è®¾ç½®æ ‡é¢˜
    caption.textContent = img.alt || img.title || `å›¾ç‰‡ ${currentImageIndex + 1}`;

    // è®¾ç½®è®¡æ•°å™¨
    if (lightboxImages.length > 1) {
        counter.textContent = `${currentImageIndex + 1} / ${lightboxImages.length}`;
    } else {
        counter.textContent = '';
    }

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    updateLightboxButtons();
}

// ä¸Šä¸€å¼ å›¾ç‰‡
function showPrevImage() {
    if (lightboxImages.length === 0) return;
    currentImageIndex = (currentImageIndex - 1 + lightboxImages.length) % lightboxImages.length;
    showCurrentImage();
}

// ä¸‹ä¸€å¼ å›¾ç‰‡
function showNextImage() {
    if (lightboxImages.length === 0) return;
    currentImageIndex = (currentImageIndex + 1) % lightboxImages.length;
    showCurrentImage();
}

// æ›´æ–°æŒ‰é’®çŠ¶æ€
function updateLightboxButtons() {
    const prevBtn = document.querySelector('.lightbox-prev');
    const nextBtn = document.querySelector('.lightbox-next');

    if (lightboxImages.length <= 1) {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
    } else {
        prevBtn.style.display = 'flex';
        nextBtn.style.display = 'flex';
    }
}

// é”®ç›˜äº‹ä»¶å¤„ç†
function handleLightboxKeyboard(e) {
    switch(e.key) {
        case 'Escape':
            closeLightbox();
            break;
        case 'ArrowLeft':
            showPrevImage();
            break;
        case 'ArrowRight':
            showNextImage();
            break;
    }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ç¯ç®±
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initLightbox);
} else {
    initLightbox();
}

</script>
{% endblock %}
