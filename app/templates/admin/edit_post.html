{% extends "base.html" %}

{% block title %}{% if post %}编辑文章{% else %}新建文章{% endif %} - 我的博客{% endblock %}

{% block content %}
<div class="main-container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="sidebar-widget">
                <h1 class="mb-4">
                    <i class="bi bi-{% if post %}pencil{% else %}plus-lg{% endif %}"></i>
                    {% if post %}编辑文章{% else %}新建文章{% endif %}
                </h1>

                <form method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="mb-3">
                        <label for="title" class="form-label">文章标题 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="title" name="title"
                               value="{% if post %}{{ post.title }}{% endif %}" required>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="category_id" class="form-label">分类</label>
                            <select class="form-select" id="category_id" name="category_id">
                                <option value="">选择分类（可选）</option>
                                {% for category in categories %}
                                    <option value="{{ category.id }}"
                                            {% if post and post.category_id == category.id %}selected{% endif %}>
                                        {{ category.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">封面图片（可选）</label>
                            <div class="mb-2">
                                <div class="btn-group" role="group">
                                    <input type="radio" class="btn-check" name="cover_image_type" id="coverTypeUrl" value="url" autocomplete="off"
                                           {% if not post or not post.cover_image or (post.cover_image.startswith('http') and 'raw.githubusercontent.com' not in post.cover_image and 'githubusercontent.com' not in post.cover_image) %}checked{% endif %}>
                                    <label class="btn btn-outline-secondary" for="coverTypeUrl">
                                        <i class="bi bi-link-45deg"></i> URL链接
                                    </label>

                                    <input type="radio" class="btn-check" name="cover_image_type" id="coverTypeFile" value="file" autocomplete="off"
                                           {% if post and post.cover_image and (post.cover_image.startswith('/static/') or 'githubusercontent.com' in post.cover_image) %}checked{% endif %}>
                                    <label class="btn btn-outline-secondary" for="coverTypeFile">
                                        <i class="bi bi-upload"></i> 本地上传
                                    </label>
                                </div>
                            </div>

                            <!-- URL输入 -->
                            <div id="coverImageUrlSection" class="{% if post and post.cover_image and (post.cover_image.startswith('/static/') or 'githubusercontent.com' in post.cover_image) %}d-none{% endif %}">
                                <input type="url" class="form-control" id="cover_image_url" name="cover_image_url"
                                       value="{% if post and post.cover_image and (post.cover_image.startswith('http') and 'githubusercontent.com' not in post.cover_image) %}{{ post.cover_image }}{% endif %}"
                                       placeholder="https://example.com/image.jpg">
                            </div>

                            <!-- 文件上传 -->
                            <div id="coverImageFileSection" class="{% if not post or not post.cover_image or (post.cover_image.startswith('http') and 'githubusercontent.com' not in post.cover_image) %}d-none{% endif %}">
                                <input type="file" class="form-control" id="cover_image_file" name="cover_image_file"
                                       accept="image/png,image/jpeg,image/gif,image/webp">
                                <input type="hidden" id="cover_image" name="cover_image"
                                       value="{% if post and post.cover_image %}{{ post.cover_image }}{% endif %}">
                                <div class="form-text">支持 PNG, JPG, GIF, WebP 格式，最大 16MB，上传后保存到 GitHub 图床</div>
                            </div>

                            <!-- 图片预览 -->
                            {% if post and post.cover_image %}
                            <div class="mt-2">
                                <img id="coverPreview" src="{{ post.cover_image }}"
                                     style="max-width: 100%; max-height: 200px; object-fit: cover; border-radius: 8px; display: block;"
                                     onerror="this.style.display='none'">
                            </div>
                            {% else %}
                            <div class="mt-2">
                                <img id="coverPreview" src=""
                                     style="max-width: 100%; max-height: 200px; object-fit: cover; border-radius: 8px; display: none;">
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="summary" class="form-label">
                            摘要（可选）
                            <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="generateSummary()">
                                <i class="bi bi-magic"></i> 自动生成
                            </button>
                        </label>
                        <input type="text" class="form-control" id="summary" name="summary"
                               value="{% if post and post.summary %}{{ post.summary }}{% endif %}"
                               placeholder="简短描述文章内容，显示在首页（最多300字）">
                        <div class="form-text">将显示在文章列表中，留空则自动生成</div>
                    </div>

                    <div class="mb-3">
                        <label for="content" class="form-label">
                            文章内容 <span class="text-danger">*</span>
                            <small class="text-muted">(支持 Markdown)</small>
                            <div class="float-end">
                                <button type="button" class="btn btn-sm btn-outline-primary me-1" onclick="document.getElementById('contentImageInput').click()">
                                    <i class="bi bi-image"></i> 插入图片
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-success" onclick="document.getElementById('mdFileInput').click()">
                                    <i class="bi bi-file-earmark-markup"></i> 导入 MD 文件
                                </button>
                            </div>
                        </label>
                        <input type="file" id="mdFileInput" accept=".md" style="display: none" onchange="importMarkdown(this)">
                        <input type="file" id="contentImageInput" accept="image/png,image/jpeg,image/gif,image/webp" style="display: none" onchange="insertContentImage(this)">
                        <textarea class="form-control" id="content" name="content" rows="15"
                                  required>{% if post %}{{ post.content }}{% endif %}</textarea>
                        <div class="form-text">支持 Markdown 格式，可导入 .md 文件 | 快捷键: Ctrl+I 插入图片</div>

                        <!-- 选中本地图片路径时的上传提示按钮 -->
                        <div id="imageUploadPrompt" class="image-upload-prompt" style="display: none;">
                            <i class="bi bi-upload"></i> 上传这张图片
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">标签</label>
                        <div>
                            {% for tag in tags %}
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="tags" value="{{ tag.id }}" id="tag{{ tag.id }}"
                                           {% if post and tag in post.tags %}checked{% endif %}>
                                    <label class="form-check-label badge-tag" for="tag{{ tag.id }}">
                                        {{ tag.name }}
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                        {% if tags|length == 0 %}
                            <small class="text-muted">
                                还没有标签，在管理后台创建
                            </small>
                        {% endif %}
                    </div>

                    <!-- 定时发布 -->
                    <div class="mb-3">
                        <div class="form-check mb-2">
                            <input type="checkbox" class="form-check-input" id="scheduled" name="scheduled"
                                   onchange="toggleScheduledFields()"
                                   {% if post and post.scheduled_at %}checked{% endif %}>
                            <label class="form-check-label" for="scheduled">
                                <i class="bi bi-clock"></i> 定时发布
                            </label>
                        </div>

                        <div id="scheduledFields" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="scheduled_date" class="form-label">日期</label>
                                    <input type="date" class="form-control" id="scheduled_date" name="scheduled_date"
                                           {% if post and post.scheduled_at %}value="{{ post.scheduled_at.strftime('%Y-%m-%d') }}"{% endif %}>
                                </div>
                                <div class="col-md-6">
                                    <label for="scheduled_time" class="form-label">时间</label>
                                    <input type="time" class="form-control" id="scheduled_time" name="scheduled_time"
                                           {% if post and post.scheduled_at %}value="{{ post.scheduled_at.strftime('%H:%M') }}"{% endif %}
                                           value="00:00">
                                </div>
                            </div>
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i>
                                设置定时发布后，文章将在指定时间自动发布，在此之前为草稿状态
                            </small>
                        </div>
                    </div>

                    <div class="mb-4 form-check">
                        <input type="checkbox" class="form-check-input" id="published" name="published"
                               {% if post and post.published %}checked{% endif %}
                               {% if not post %}checked{% endif %}>
                        <label class="form-check-label" for="published">
                            <i class="bi bi-globe"></i> 立即发布
                            <small class="text-muted">(取消勾选将保存为草稿)</small>
                        </label>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg"></i> 保存
                        </button>
                        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-lg"></i> 取消
                        </a>
                        {% if post %}
                            <a href="{{ url_for('main.post', post_id=post.id) }}" class="btn btn-outline-info ms-auto" target="_blank">
                                <i class="bi bi-eye"></i> 预览
                            </a>
                        {% endif %}
                    </div>
                </form>

                <!-- Markdown 语法提示 -->
                <div class="mt-4 p-4" style="background: var(--bg-color); border-radius: 8px;">
                    <h6 class="mb-3"><i class="bi bi-code-square"></i> Markdown 快速参考</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <small>
                                <strong>标题:</strong> # 一级标题<br>
                                <strong>粗体:</strong> **粗体文本**<br>
                                <strong>斜体:</strong> *斜体文本*<br>
                                <strong>链接:</strong> [文本](URL)
                            </small>
                        </div>
                        <div class="col-md-6">
                            <small>
                                <strong>代码:</strong> `代码` 或 ```代码块```<br>
                                <strong>列表:</strong> - 项目 或 1. 项目<br>
                                <strong>引用:</strong> > 引用文本<br>
                                <strong>图片:</strong> ![alt](URL)
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 封面图片类型切换
document.addEventListener('DOMContentLoaded', function() {
    const coverTypeUrl = document.getElementById('coverTypeUrl');
    const coverTypeFile = document.getElementById('coverTypeFile');
    const coverImageUrlSection = document.getElementById('coverImageUrlSection');
    const coverImageFileSection = document.getElementById('coverImageFileSection');
    const coverImageFile = document.getElementById('cover_image_file');
    const coverImageInput = document.getElementById('cover_image');
    const coverPreview = document.getElementById('coverPreview');

    function switchCoverType(type) {
        if (type === 'url') {
            coverImageUrlSection.classList.remove('d-none');
            coverImageFileSection.classList.add('d-none');
        } else {
            coverImageUrlSection.classList.add('d-none');
            coverImageFileSection.classList.remove('d-none');
        }
    }

    coverTypeUrl.addEventListener('change', function() {
        if (this.checked) {
            switchCoverType('url');
            // 同步 URL 到隐藏字段
            const urlInput = document.getElementById('cover_image_url');
            coverImageInput.value = urlInput.value;
            coverPreview.src = urlInput.value;
            coverPreview.style.display = urlInput.value ? 'block' : 'none';
        }
    });

    coverTypeFile.addEventListener('change', function() {
        if (this.checked) {
            switchCoverType('file');
        }
    });

    // URL 输入时同步到隐藏字段和预览
    const urlInput = document.getElementById('cover_image_url');
    if (urlInput) {
        urlInput.addEventListener('input', function() {
            coverImageInput.value = this.value;
            coverPreview.src = this.value;
            coverPreview.style.display = this.value ? 'block' : 'none';
        });
    }

    // 文件选择后自动上传
    coverImageFile.addEventListener('change', function() {
        const file = this.files[0];
        if (!file) return;

        // 验证文件大小
        if (file.size > 16 * 1024 * 1024) {
            alert('文件大小不能超过 16MB');
            this.value = '';
            return;
        }

        // 验证文件类型
        const allowedTypes = ['image/png', 'image/jpeg', 'image/gif', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            alert('不支持的文件类型。请上传 PNG, JPG, GIF 或 WebP 格式的图片');
            this.value = '';
            return;
        }

        // 创建 FormData 上传文件
        const formData = new FormData();
        formData.append('cover_image', file);

        // 显示上传中状态
        const uploadButton = this;
        uploadButton.disabled = true;
        const originalText = uploadButton.parentNode.querySelector('.form-text')?.textContent || '';
        if (uploadButton.parentNode.querySelector('.form-text')) {
            uploadButton.parentNode.querySelector('.form-text').textContent = '上传中...';
        }

        fetch('{{ url_for("admin.upload_cover_image") }}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            uploadButton.disabled = false;
            if (uploadButton.parentNode.querySelector('.form-text')) {
                uploadButton.parentNode.querySelector('.form-text').textContent = originalText;
            }

            if (data.success) {
                // 更新隐藏字段
                coverImageInput.value = data.image_url;
                // 显示预览
                coverPreview.src = data.image_url;
                coverPreview.style.display = 'block';
                // 显示成功消息
                alert('图片上传成功！');
            } else {
                alert('上传失败: ' + data.message);
                uploadButton.value = '';
            }
        })
        .catch(error => {
            uploadButton.disabled = false;
            if (uploadButton.parentNode.querySelector('.form-text')) {
                uploadButton.parentNode.querySelector('.form-text').textContent = originalText;
            }
            alert('上传失败: ' + error.message);
            uploadButton.value = '';
        });
    });

    // 初始化定时发布字段
    toggleScheduledFields();
});

function importMarkdown(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();

    reader.onload = async function(e) {
        let content = e.target.result;

        // 尝试解析标题和内容
        const lines = content.split('\n');
        let title = '';
        let bodyStart = 0;

        // 检查 YAML front matter
        if (lines[0] && lines[0].trim() === '---') {
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '---') {
                    bodyStart = i + 1;
                    break;
                }
                // 提取 title
                if (lines[i].startsWith('title:')) {
                    title = lines[i].split(':', 2)[1].trim().stripQuotes();
                }
            }
        } else {
            // 检查第一个 # 标题
            if (lines[0] && lines[0].trim().startsWith('#')) {
                const match = lines[0].match(/^#+\s+(.+)$/);
                if (match) {
                    title = match[1].trim();
                    bodyStart = 1;
                }
            }
        }

        // 提取正文
        const bodyContent = lines.slice(bodyStart).join('\n').trim();

        // 填充表单
        if (title && !document.getElementById('title').value) {
            document.getElementById('title').value = title;
        }

        // 自动生成摘要
        if (bodyContent.length > 0 && !document.getElementById('summary').value) {
            const summary = bodyContent.substring(0, 200) + (bodyContent.length > 200 ? '...' : '');
            document.getElementById('summary').value = summary;
        }

        // 填充内容
        document.getElementById('content').value = bodyContent;

        // 检测本地图片
        await detectAndPromptLocalImages(bodyContent);

        // 显示基本成功提示
        showSaveIndicator('Markdown 文件导入成功！');
    };

    reader.onerror = function() {
        alert('读取文件失败，请重试');
    };

    // 尝试多种编码读取
    readWithEncoding(file, reader);
}

// 检测并提示本地图片
async function detectAndPromptLocalImages(content) {
    try {
        const response = await fetch('{{ url_for("admin.detect_local_images") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ content: content })
        });

        // 检查响应状态
        if (!response.ok) {
            console.error('检测本地图片失败:', response.status, response.statusText);
            return;
        }

        const data = await response.json();

        if (data.count > 0) {
            showLocalImagesPrompt(data.local_images);
        }
    } catch (error) {
        console.error('检测本地图片失败:', error);
    }
}

// 显示本地图片提示对话框
function showLocalImagesPrompt(localImages) {
    // 存储本地图片信息供后续使用
    window.detectedLocalImages = localImages;

    // 创建增强版模态框
    const modalHtml = `
        <div id="localImagesModal" class="modal" style="display: block; background: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-images"></i>
                            检测到本地图片路径 (${localImages.length} 张)
                        </h5>
                        <button type="button" class="btn-close btn-close-white" onclick="closeLocalImagesModal()"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle-fill"></i>
                            检测到文章中包含本地图片路径，这些图片无法在服务器上显示。请选择以下方式处理：
                        </div>

                        <!-- 图片列表，每个都有上传按钮 -->
                        <div class="local-images-list mb-3" style="max-height: 300px; overflow-y: auto;">
                            ${localImages.map((img, index) => `
                                <div class="local-image-item" data-index="${index}" data-path="${escapeHtml(img.path)}" data-filename="${escapeHtml(img.filename)}">
                                    <div class="d-flex align-items-center p-2 border rounded mb-2">
                                        <div class="image-icon me-3">
                                            <i class="bi bi-file-image"></i>
                                        </div>
                                        <div class="image-info flex-grow-1">
                                            <div class="image-filename">${escapeHtml(img.filename)}</div>
                                            <div class="image-path text-muted small">${escapeHtml(img.path)}</div>
                                        </div>
                                        <div class="image-actions">
                                            <input type="file" id="fileInput_${index}" accept="image/png,image/jpeg,image/gif,image/webp"
                                                class="d-none" onchange="uploadLocalImage(${index}, this)">
                                            <button class="btn btn-sm btn-outline-primary" onclick="document.getElementById('fileInput_${index}').click()">
                                                <i class="bi bi-upload"></i> 上传
                                            </button>
                                            <span class="upload-status ms-2" id="status_${index}"></span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" onclick="closeLocalImagesModal()">
                            <i class="bi bi-clock"></i> 稍后上传
                        </button>
                        <button type="button" class="btn btn-primary" onclick="closeLocalImagesModal()">
                            <i class="bi bi-check-lg"></i> 完成
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // 添加到页面
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHtml;
    document.body.appendChild(modalContainer);
}

// 关闭本地图片提示框
function closeLocalImagesModal() {
    const modal = document.getElementById('localImagesModal');
    if (modal) {
        modal.remove();
    }
}

// ========================================
// 本地图片上传功能
// ========================================

// 上传单个本地图片
function uploadLocalImage(index, input) {
    const file = input.files[0];
    if (!file) return;

    const imageItem = document.querySelector(`.local-image-item[data-index="${index}"]`);
    const statusEl = document.getElementById(`status_${index}`);
    const originalPath = imageItem.getAttribute('data-path');
    const textarea = document.getElementById('content');

    // 显示上传中状态
    statusEl.innerHTML = '<span class="badge bg-warning text-dark">上传中...</span>';

    const formData = new FormData();
    formData.append('cover_image', file);

    fetch('{{ url_for("admin.upload_cover_image") }}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 生成新的 Markdown 图片语法
            const altText = file.name.replace(/\.[^/.]+$/, '');
            const newImageMd = `![${altText}](${data.image_url})`;

            // 在文章内容中替换所有匹配的路径
            const currentContent = textarea.value;
            const newContent = currentContent.split(originalPath).join(newImageMd);
            textarea.value = newContent;

            // 更新 UI
            statusEl.innerHTML = '<span class="badge bg-success">✓ 已替换</span>';
            imageItem.classList.add('upload-success');
            imageItem.style.opacity = '0.6';

            showSaveIndicator(`已替换: ${file.name}`);
        } else {
            statusEl.innerHTML = '<span class="badge bg-danger">✗ 失败</span>';
            alert('上传失败: ' + data.message);
        }
    })
    .catch(error => {
        statusEl.innerHTML = '<span class="badge bg-danger">✗ 错误</span>';
        alert('上传失败: ' + error.message);
    });
}

// 打开图片上传
function openImageUpload() {
    closeLocalImagesModal();
    document.getElementById('contentImageInput').click();
}

// HTML 转义函数
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function readWithEncoding(file, reader) {
    // 优先使用 UTF-8
    reader.readAsText(file, 'UTF-8');
}

// String.prototype.trim polyfill for old browsers
if (!String.prototype.stripQuotes) {
    String.prototype.stripQuotes = function() {
        return this.replace(/^["']|["']$/g, '');
    };
}

// ========================================
// 定时发布功能
// ========================================

function toggleScheduledFields() {
    const scheduled = document.getElementById('scheduled').checked;
    const scheduledFields = document.getElementById('scheduledFields');
    const publishedCheckbox = document.getElementById('published');

    if (scheduled) {
        scheduledFields.style.display = 'block';
        // 禁用立即发布选项
        if (publishedCheckbox) {
            publishedCheckbox.disabled = true;
            publishedCheckbox.checked = false;
        }
    } else {
        scheduledFields.style.display = 'none';
        // 启用立即发布选项
        if (publishedCheckbox) {
            publishedCheckbox.disabled = false;
        }
    }
}

// ========================================
// 自动生成摘要功能
// ========================================

async function generateSummary() {
    const content = document.getElementById('content').value.trim();

    if (!content) {
        alert('请先输入文章内容');
        return;
    }

    // 显示加载状态
    const summaryInput = document.getElementById('summary');
    const originalPlaceholder = summaryInput.placeholder;
    summaryInput.placeholder = '正在生成摘要...';
    summaryInput.disabled = true;

    try {
        const response = await fetch('{{ url_for("admin.api_generate_summary") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ content: content })
        });

        if (!response.ok) {
            throw new Error('生成失败');
        }

        const data = await response.json();

        if (data.summary) {
            summaryInput.value = data.summary;
            showSaveIndicator('摘要已生成');
        } else {
            throw new Error('未返回摘要');
        }
    } catch (error) {
        console.error('生成摘要失败:', error);
        // 如果API调用失败，使用前端简单生成
        const simpleSummary = content
            .replace(/```[\s\S]*?```/g, '') // 移除代码块
            .replace(/`[^`]+`/g, '') // 移除行内代码
            .replace(/^#+\s+/gm, '') // 移除标题
            .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // 移除链接
            .split(/[。！？.!?]/)[0] // 按句子分割
            .trim()
            .substring(0, 280);

        summaryInput.value = simpleSummary + (simpleSummary.length < content.length ? '...' : '');
        showSaveIndicator('使用简单摘要生成');
    } finally {
        summaryInput.placeholder = originalPlaceholder;
        summaryInput.disabled = false;
    }
}

// ========================================
// 草稿自动保存功能
// ========================================

const DRAFT_KEY = 'blog_post_draft';
const AUTOSAVE_INTERVAL = 30000; // 30秒

// 获取当前文章ID（用于区分不同文章的草稿）
function getPostId() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('post_id') || 'new';
}

// 保存草稿到 localStorage
function saveDraft() {
    const draft = {
        postId: getPostId(),
        title: document.getElementById('title').value,
        summary: document.getElementById('summary').value,
        content: document.getElementById('content').value,
        category: document.getElementById('category_id').value,
        tags: Array.from(document.querySelectorAll('input[name="tags"]:checked')).map(el => el.value),
        coverImage: document.getElementById('cover_image').value,
        savedAt: new Date().toISOString()
    };

    localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));

    // 显示保存提示
    showSaveIndicator('已自动保存');
}

// 从 localStorage 恢复草稿
function restoreDraft() {
    const savedDraft = localStorage.getItem(DRAFT_KEY);
    if (!savedDraft) return;

    const draft = JSON.parse(savedDraft);

    // 检查草稿是否属于当前文章
    if (draft.postId !== getPostId()) {
        // 显示恢复提示
        const otherDraft = confirm(`检测到其他文章的草稿（保存于 ${new Date(draft.savedAt).toLocaleString()}）\n\n是否恢复该草稿？`);
        if (!otherDraft) {
            return;
        }
    }

    // 恢复草稿内容
    if (draft.title && !document.getElementById('title').value) {
        document.getElementById('title').value = draft.title;
    }
    if (draft.summary && !document.getElementById('summary').value) {
        document.getElementById('summary').value = draft.summary;
    }
    if (draft.content && !document.getElementById('content').value) {
        document.getElementById('content').value = draft.content;
    }
    if (draft.category && !document.getElementById('category_id').value) {
        document.getElementById('category_id').value = draft.category;
    }
    if (draft.coverImage && !document.getElementById('cover_image').value) {
        document.getElementById('cover_image').value = draft.coverImage;
        const preview = document.getElementById('coverPreview');
        if (preview) {
            preview.src = draft.coverImage;
            preview.style.display = 'block';
        }
    }

    // 恢复标签选择
    if (draft.tags && draft.tags.length > 0) {
        document.querySelectorAll('input[name="tags"]').forEach(checkbox => {
            if (draft.tags.includes(checkbox.value)) {
                checkbox.checked = true;
            }
        });
    }

    showSaveIndicator('草稿已恢复');
}

// 显示保存指示器
function showSaveIndicator(message) {
    let indicator = document.getElementById('autosaveIndicator');
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'autosaveIndicator';
        indicator.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #22c55e;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 9999;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
        `;
        document.body.appendChild(indicator);
    }

    indicator.textContent = message;
    indicator.style.opacity = '1';

    setTimeout(() => {
        indicator.style.opacity = '0';
    }, 2000);
}

// 清除草稿（表单提交后）
function clearDraft() {
    localStorage.removeItem(DRAFT_KEY);
}

// 初始化自动保存
document.addEventListener('DOMContentLoaded', function() {
    // 尝试恢复草稿
    restoreDraft();

    // 设置自动保存定时器
    const autosaveTimer = setInterval(saveDraft, AUTOSAVE_INTERVAL);

    // 监听表单提交，清除草稿
    const form = document.querySelector('form[method="POST"]');
    if (form) {
        form.addEventListener('submit', function() {
            clearInterval(autosaveTimer);
            clearDraft();
        });
    }

    // 监听内容变化，实时更新保存状态
    const contentTextarea = document.getElementById('content');
    if (contentTextarea) {
        let saveTimeout;
        contentTextarea.addEventListener('input', function() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                showSaveIndicator('正在保存...');
                saveDraft();
            }, 1000);
        });

        // 添加快捷键 Ctrl+I 插入图片
        contentTextarea.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'i') {
                e.preventDefault();
                document.getElementById('contentImageInput').click();
            }
        });

        // 监听文本选择，检测本地图片路径
        contentTextarea.addEventListener('mouseup', handleTextSelection);
        contentTextarea.addEventListener('keyup', handleTextSelection);
    }
});

// ========================================
// 本地图片路径上传提示
// ========================================

let selectionUploadTimeout;

function handleTextSelection() {
    clearTimeout(selectionUploadTimeout);

    selectionUploadTimeout = setTimeout(() => {
        const textarea = document.getElementById('content');
        const selectedText = getSelectedText(textarea);

        if (selectedText && isLocalImagePath(selectedText)) {
            showImageUploadPrompt(textarea, selectedText);
        } else {
            hideImageUploadPrompt();
        }
    }, 300);
}

function getSelectedText(textarea) {
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    return textarea.value.substring(start, end).trim();
}

function isLocalImagePath(text) {
    if (!text) return false;

    // 移除可能的 Markdown 图片语法包裹
    let cleanText = text;

    // 检查是否是不完整的 Markdown 图片语法（只有 alt 文本部分）
    // 格式：![alt text] 或 ![alt text](
    const partialMdImageRegex = /^!\[([^\]]*)\]?(\(?=\)?$|^\!\[[^\]]*\]$/;
    if (partialMdImageRegex.test(text)) {
        // 这是图片语法的一部分，应该提示替换
        return true;
    }

    // 如果文本包含完整的 Markdown 图片语法 ![alt](url)，提取其中的 URL 部分
    const mdImageRegex = /^!\[([^\]]*)\]\(([^)]+)\)$/;
    const match = text.match(mdImageRegex);
    if (match) {
        cleanText = match[2]; // 使用 URL 部分
    }

    // 检查是否是 Windows 路径
    if (cleanText.length >= 2 && cleanText[1] === ':' && cleanText[0].match(/[a-z]/i)) {
        return true;
    }

    // 检查是否是本地路径（以 /static/ 开头或相对路径）
    if (cleanText.startsWith('/static/') || cleanText.startsWith('./') || cleanText.startsWith('../')) {
        return true;
    }

    // 检查是否以 .jpg, .png, .gif 等图片扩展名结尾（但不是完整的 URL）
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp'];
    const lowerText = cleanText.toLowerCase();

    // 如果是完整的 HTTP(S) URL，不认为是本地路径
    if (lowerText.startsWith('http://') || lowerText.startsWith('https://')) {
        return false;
    }

    return imageExtensions.some(ext => lowerText.endsWith(ext));
}

function showImageUploadPrompt(textarea, imagePath) {
    const prompt = document.getElementById('imageUploadPrompt');
    const textareaRect = textarea.getBoundingClientRect();

    // 设置提示按钮位置
    prompt.style.top = (textareaRect.top + window.pageYOffset + textareaRect.height + 5) + 'px';
    prompt.style.left = (textareaRect.left + window.pageXOffset + 10) + 'px';
    prompt.style.display = 'flex';

    // 设置点击事件
    prompt.onclick = function() {
        // 创建文件输入选择对应的图片
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/png,image/jpeg,image/gif,image/webp';
        input.onchange = function() {
            replaceLocalImageWithPath(this, imagePath, textarea);
        };
        input.click();
    };
}

function hideImageUploadPrompt() {
    const prompt = document.getElementById('imageUploadPrompt');
    prompt.style.display = 'none';
}

function replaceLocalImageWithPath(input, oldPath, textarea) {
    const file = input.files[0];
    if (!file) return;

    // 验证文件
    if (file.size > 16 * 1024 * 1024) {
        alert('文件大小不能超过 16MB');
        return;
    }

    const allowedTypes = ['image/png', 'image/jpeg', 'image/gif', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        alert('不支持的文件类型');
        return;
    }

    // 上传图片
    const formData = new FormData();
    formData.append('cover_image', file);

    const originalButtonText = document.getElementById('imageUploadPrompt').innerHTML;
    document.getElementById('imageUploadPrompt').innerHTML = '<i class="bi bi-hourglass-split"></i> 上传中...';

    fetch('{{ url_for("admin.upload_cover_image") }}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const currentValue = textarea.value;
            const selectedText = currentValue.substring(start, end).trim();

            // 检查选中的文本是否是完整的 Markdown 图片语法
            const mdImageRegex = /^!\[([^\]]*)\]\(([^)]+)\)$/;
            const isMdImage = mdImageRegex.test(selectedText);

            let newImageMd;
            let replaceStart, replaceEnd;

            if (isMdImage) {
                // 选中的是完整的图片语法，替换整个语法
                const altText = file.name.replace(/\.[^/.]+$/, '');
                newImageMd = `![${altText}](${data.image_url})`;
                replaceStart = start;
                replaceEnd = end;
            } else {
                // 选中的不是完整图片语法，检查是否在图片语法中
                const textBefore = currentValue.substring(0, start);
                const textAfter = currentValue.substring(end);

                // 查找是否有完整的图片语法包含选中位置
                let imageStart = textBefore.lastIndexOf('![');
                let imageEnd = end + textAfter.indexOf(')') + 1;

                // 检查是否能找到完整的图片语法
                if (imageStart >= 0 && imageEnd > end && imageEnd <= currentValue.length) {
                    const potentialImage = currentValue.substring(imageStart, imageEnd);
                    if (mdImageRegex.test(potentialImage)) {
                        // 在完整的图片语法中，替换整个语法
                        const altText = file.name.replace(/\.[^/.]+$/, '');
                        newImageMd = `![${altText}](${data.image_url})`;
                        replaceStart = imageStart;
                        replaceEnd = imageEnd;
                    } else {
                        // 不是图片语法，直接替换选中的文本
                        const altText = file.name.replace(/\.[^/.]+$/, '');
                        newImageMd = `![${altText}](${data.image_url})`;
                        replaceStart = start;
                        replaceEnd = end;
                    }
                } else {
                    // 没有找到完整图片语法，直接替换选中文本
                    const altText = file.name.replace(/\.[^/.]+$/, '');
                    newImageMd = `![${altText}](${data.image_url})`;
                    replaceStart = start;
                    replaceEnd = end;
                }
            }

            // 替换内容
            textarea.value = currentValue.substring(0, replaceStart) + newImageMd + currentValue.substring(replaceEnd);

            // 设置光标位置
            const newPosition = replaceStart + newImageMd.length;
            textarea.setSelectionRange(newPosition, newPosition);
            textarea.focus();

            showSaveIndicator('图片已替换');
        } else {
            alert('上传失败: ' + data.message);
        }
    })
    .catch(error => {
        alert('上传失败: ' + error.message);
    })
    .finally(() => {
        document.getElementById('imageUploadPrompt').innerHTML = originalButtonText;
        hideImageUploadPrompt();
    });
}

// 点击其他地方时隐藏提示
document.addEventListener('click', function(e) {
    if (e.target.id !== 'content' && e.target.id !== 'imageUploadPrompt') {
        hideImageUploadPrompt();
    }
});

// ========================================
// 插入图片到文章内容
// ========================================

function insertContentImage(input) {
    const file = input.files[0];
    if (!file) return;

    // 验证文件大小
    if (file.size > 16 * 1024 * 1024) {
        alert('文件大小不能超过 16MB');
        input.value = '';
        return;
    }

    // 验证文件类型
    const allowedTypes = ['image/png', 'image/jpeg', 'image/gif', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        alert('不支持的文件类型。请上传 PNG, JPG, GIF 或 WebP 格式的图片');
        input.value = '';
        return;
    }

    const textarea = document.getElementById('content');
    const cursorPos = textarea.selectionStart;
    const textBeforeCursor = textarea.value.substring(0, cursorPos);
    const textAfterCursor = textarea.value.substring(cursorPos);

    // 检查光标是否在已有的 Markdown 图片语法中
    // 查找光标前的 ![ 和可能的 ](
    const beforeImageSyntax = textBeforeCursor.match(/!\[[^\]]*?\]?$/);
    const afterImageSyntax = textAfterCursor.match(/^\]?\([^\)]*$/);

    if (beforeImageSyntax && afterImageSyntax) {
        // 光标在已有的图片语法中间，询问用户是否要替换
        if (!confirm('检测到光标在已有的图片语法中，是否要替换该图片？')) {
            input.value = '';
            return;
        }

        // 找到完整的图片语法
        const fullText = textarea.value;
        let imageStart = textBeforeCursor.lastIndexOf('![');
        let imageEnd = cursorPos + textAfterCursor.indexOf(')') + 1;

        if (imageEnd <= imageStart) {
            imageEnd = cursorPos + textAfterCursor.indexOf(')') + 1;
        }

        const oldImageMd = fullText.substring(imageStart, imageEnd);
        const textBeforeImage = fullText.substring(0, imageStart);
        const textAfterImage = fullText.substring(imageEnd);

        // 上传新图片并替换
        const fileName = file.name.replace(/\.[^/.]+$/, '');
        const formData = new FormData();
        formData.append('cover_image', file);

        textarea.value = textBeforeImage + `![正在替换图片...](${fileName})` + textAfterImage;

        fetch('{{ url_for("admin.upload_cover_image") }}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const newImageMd = `![${fileName}](${data.image_url})`;
                textarea.value = textBeforeImage + newImageMd + textAfterImage;
                showSaveIndicator('图片已替换！');
            } else {
                textarea.value = fullText;
                alert('上传失败: ' + data.message);
            }
        })
        .catch(error => {
            textarea.value = fullText;
            alert('上传失败: ' + error.message);
        })
        .finally(() => {
            input.value = '';
        });
        return;
    }

    // 检查是否有选中的文字（可能是本地路径）
    const selectedText = getSelectedText(textarea);
    const hasSelection = textarea.selectionStart !== textarea.selectionEnd;

    // 如果选中了本地路径，则进行替换模式
    if (hasSelection && selectedText && isLocalImagePath(selectedText)) {
        uploadAndReplaceLocalPath(file, selectedText, textarea);
        return;
    }

    // 正常插入模式
    const fileName = file.name.replace(/\.[^/.]+$/, '');

    // 创建 FormData 上传文件
    const formData = new FormData();
    formData.append('cover_image', file);

    // 显示上传中状态
    const textBefore = textarea.value.substring(0, textarea.selectionStart);
    const textAfter = textarea.value.substring(textarea.selectionEnd);

    // 临时插入上传中提示
    textarea.value = textBefore + `![正在上传图片...](${fileName})` + textAfter;
    showSaveIndicator('正在上传图片...');

    fetch('{{ url_for("admin.upload_cover_image") }}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 生成 Markdown 图片语法
            const imageMd = `![${fileName}](${data.image_url})`;
            textarea.value = textBefore + imageMd + textAfter;

            // 设置光标位置到插入的图片后面
            const newCursorPos = textBefore.length + imageMd.length;
            textarea.setSelectionRange(newCursorPos, newCursorPos);
            textarea.focus();

            showSaveIndicator('图片插入成功！');
        } else {
            // 恢复原内容
            textarea.value = textBefore + textAfter;
            alert('上传失败: ' + data.message);
        }
    })
    .catch(error => {
        // 恢复原内容
        textarea.value = textBefore + textAfter;
        alert('上传失败: ' + error.message);
    })
    .finally(() => {
        input.value = '';
    });
}

// 上传图片并替换选中的本地路径
function uploadAndReplaceLocalPath(file, localPath, textarea) {
    const formData = new FormData();
    formData.append('cover_image', file);

    // 显示上传中状态
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const currentValue = textarea.value;
    const selectedText = currentValue.substring(start, end).trim();

    // 临时替换为上传中提示
    textarea.value = currentValue.substring(0, start) + `[正在上传: ${file.name}]` + currentValue.substring(end);

    fetch('{{ url_for("admin.upload_cover_image") }}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const mdImageRegex = /^!\[([^\]]*)\]\(([^)]+)\)$/;
            let newImageMd;
            let replaceStart, replaceEnd;

            // 优先检查选中的文本是否是完整的 Markdown 图片语法
            if (mdImageRegex.test(selectedText)) {
                // 选中的是完整的图片语法，替换整个语法
                const altText = file.name.replace(/\.[^/.]+$/, '');
                newImageMd = `![${altText}](${data.image_url})`;
                replaceStart = start;
                replaceEnd = end;
            } else {
                // 选中的不是完整图片语法，查找是否在图片语法中
                const textBefore = currentValue.substring(0, start);
                const textAfter = currentValue.substring(end);

                // 查找选中文本前后是否有图片语法标记
                // 检查前面是否有 ![
                const beforeBrackets = textBefore.lastIndexOf('![');
                const beforeParen = textBefore.lastIndexOf('(');

                // 检查后面是否有 )
                const afterParen = textAfter.indexOf(')');

                // 判断是否在图片语法内部
                // 条件：前面有 ![( 或者 [( 且后面有 )
                const isInImageSyntax = (beforeBrackets >= 0 || (beforeParen >= 0 && beforeBrackets < 0)) && afterParen >= 0;

                if (isInImageSyntax) {
                    // 尝试找到完整的图片语法起始位置
                    let imageStart = textBefore.lastIndexOf('![');
                    if (imageStart < 0) {
                        // 可能是只有 alt 文本没有 ![ 前缀的情况
                        // 检查前面是否有 (
                        imageStart = textBefore.lastIndexOf('(');
                    }

                    // 找到图片语法结束位置
                    let imageEnd = end + textAfter.indexOf(')') + 1;

                    // 验证是否能形成完整的图片语法
                    if (imageStart >= 0 && imageEnd > start && imageEnd <= currentValue.length) {
                        const potentialImage = currentValue.substring(imageStart, imageEnd);
                        if (mdImageRegex.test(potentialImage) || /^!\[([^\]]*)\]$/.test(potentialImage)) {
                            // 在完整的图片语法中或只有 alt 部分，替换整个语法
                            const altText = file.name.replace(/\.[^/.]+$/, '');
                            newImageMd = `![${altText}](${data.image_url})`;
                            replaceStart = imageStart;
                            replaceEnd = imageEnd;
                        } else {
                            // 无法确认，直接替换选中的文本
                            const altText = file.name.replace(/\.[^/.]+$/, '');
                            newImageMd = `![${altText}](${data.image_url})`;
                            replaceStart = start;
                            replaceEnd = end;
                        }
                    } else {
                        // 无法找到完整的语法，直接替换选中的文本
                        const altText = file.name.replace(/\.[^/.]+$/, '');
                        newImageMd = `![${altText}](${data.image_url})`;
                        replaceStart = start;
                        replaceEnd = end;
                    }
                } else {
                    // 不在图片语法中，直接替换选中的文本
                    const altText = file.name.replace(/\.[^/.]+$/, '');
                    newImageMd = `![${altText}](${data.image_url})`;
                    replaceStart = start;
                    replaceEnd = end;
                }
            }

            // 替换内容
            textarea.value = currentValue.substring(0, replaceStart) + newImageMd + currentValue.substring(replaceEnd);

            // 设置光标位置
            const newPosition = replaceStart + newImageMd.length;
            textarea.setSelectionRange(newPosition, newPosition);
            textarea.focus();

            showSaveIndicator('本地路径已替换为上传的图片');
        } else {
            // 恢复原内容
            textarea.value = currentValue;
            alert('上传失败: ' + data.message);
        }
    })
    .catch(error => {
        textarea.value = currentValue;
        alert('上传失败: ' + error.message);
    })
    .finally(() => {
        input.value = '';
        hideImageUploadPrompt();
    });
}
</script>
{% endblock %}
