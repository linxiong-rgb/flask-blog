# 博客系统 - 完整项目文档

## 项目概述

一个功能完整的现代化博客系统，基于 Flask + SQLite 构建，支持 Markdown、分类标签、夜间模式、文件导入等丰富功能。

### 核心特性

- 用户认证系统（注册/登录）
- 文章管理（CRUD、Markdown）
- 分类和标签系统
- 全文搜索
- 夜间模式
- 响应式设计
- MD文件导入
- 浏览量统计

## 最新修复

### ✅ 已修复的问题

1. **模板过滤器错误**
   - 问题：使用了不存在的 `mapattribute` 过滤器
   - 修复：改用 SQLAlchemy 在 Python 代码中计算总浏览量
   - 文件：`app/routes/main.py`、`app/templates/index.html`

2. **数据库结构**
   - 问题：缺少新字段（category_id、views、cover_image）
   - 修复：已重置数据库，包含所有必需字段
   - 表结构：user、post、category、tag、post_tags

## 项目文件结构

```
my-blog/
├── app/                              # 应用主目录
│   ├── __init__.py                   # Flask 应用工厂
│   ├── models/                       # 数据库模型
│   │   ├── __init__.py
│   │   ├── user.py                   # 用户模型
│   │   └── post.py                   # 文章、分类、标签模型
│   ├── routes/                       # 路由（控制器）
│   │   ├── __init__.py
│   │   ├── auth.py                   # 认证路由
│   │   ├── main.py                   # 主要路由
│   │   └── admin.py                  # 管理路由
│   ├── static/                       # 静态文件
│   │   └── css/
│   │       └── style.css             # 自定义样式（含夜间模式）
│   └── templates/                    # Jinja2 模板
│       ├── base.html                 # 基础模板
│       ├── index.html                # 首页
│       ├── post.html                 # 文章详情
│       ├── about.html                # 关于页
│       ├── search.html               # 搜索页
│       ├── category.html             # 分类页
│       ├── tag.html                  # 标签页
│       ├── categories.html           # 分类列表
│       ├── auth/                     # 认证模板目录
│       │   ├── login.html
│       │   └── register.html
│       └── admin/                    # 管理模板目录
│           ├── dashboard.html        # 管理后台
│           ├── edit_post.html        # 编辑文章
│           ├── edit_category.html    # 编辑分类
│           └── import.html           # 导入MD
├── instance/                         # 实例文件夹
│   └── blog.db                       # SQLite 数据库
├── requirements.txt                  # Python 依赖
├── run.py                            # 启动脚本
├── reset_database.py                 # 数据库重置工具
├── migrate_db.py                     # 数据库迁移工具
├── fix_error.py                      # 缓存清理工具
├── README.md                         # 项目说明
├── PROJECT_GUIDE.md                  # 完整项目指南
├── QUICKSTART.md                     # 快速启动
├── TROUBLESHOOTING.md                # 故障排查
└── 示例文章.md                       # 测试用MD文件
```

## 数据库表结构

### user 表（用户）
```sql
CREATE TABLE user (
    id INTEGER PRIMARY KEY,
    username VARCHAR(80) UNIQUE NOT NULL,
    email VARCHAR(120) UNIQUE NOT NULL,
    password_hash VARCHAR(128),
    created_at DATETIME
);
```

### post 表（文章）
```sql
CREATE TABLE post (
    id INTEGER PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    summary VARCHAR(300),
    user_id INTEGER NOT NULL,
    category_id INTEGER,
    views INTEGER DEFAULT 0,
    created_at DATETIME,
    updated_at DATETIME,
    published BOOLEAN DEFAULT 1,
    cover_image VARCHAR(500),
    FOREIGN KEY (user_id) REFERENCES user(id),
    FOREIGN KEY (category_id) REFERENCES category(id)
);
```

### category 表（分类）
```sql
CREATE TABLE category (
    id INTEGER PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL,
    description VARCHAR(200),
    created_at DATETIME
);
```

### tag 表（标签）
```sql
CREATE TABLE tag (
    id INTEGER PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL,
    created_at DATETIME
);
```

### post_tags 表（文章-标签关联）
```sql
CREATE TABLE post_tags (
    post_id INTEGER NOT NULL,
    tag_id INTEGER NOT NULL,
    PRIMARY KEY (post_id, tag_id),
    FOREIGN KEY (post_id) REFERENCES post(id),
    FOREIGN KEY (tag_id) REFERENCES tag(id)
);
```

## 核心文件说明

### Python 文件（9个）

#### 1. run.py - 启动脚本
```python
from app import create_app

app = create_app()

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5000)
```

#### 2. app/__init__.py - 应用工厂
- 初始化 Flask、SQLAlchemy、LoginManager
- 注册蓝图
- 创建数据库表

#### 3. app/models/user.py - 用户模型
- User 类
- 密码加密/验证
- 用户登录

#### 4. app/models/post.py - 文章模型
- Post 类（文章）
- Category 类（分类）
- Tag 类（标签）
- post_tags 关联表

#### 5. app/routes/auth.py - 认证路由
- /auth/register - 注册
- /auth/login - 登录
- /auth/logout - 退出

#### 6. app/routes/main.py - 主要路由
- / - 首页（含分页、统计）
- /post/<id> - 文章详情
- /about - 关于
- /category/<id> - 分类文章
- /tag/<id> - 标签文章
- /categories - 分类列表
- /search - 搜索

#### 7. app/routes/admin.py - 管理路由
- /admin/ - 管理后台
- /admin/post/new - 新建文章
- /admin/post/<id>/edit - 编辑文章
- /admin/post/<id>/delete - 删除文章
- /admin/category/new - 新建分类
- /admin/category/<id>/delete - 删除分类
- /admin/tag/new - 新建标签
- /admin/tag/<id>/delete - 删除标签
- /admin/import - 导入MD
- /admin/import/batch - 批量导入

#### 8. reset_database.py - 数据库重置
删除旧数据库并重新创建所有表

#### 9. migrate_db.py - 数据库迁移
更新现有数据库结构，保留数据

### HTML 模板（14个）

#### 公共模板
1. **base.html** - 基础模板（导航栏、页脚、夜间模式）
2. **index.html** - 首页（文章列表、侧边栏）
3. **post.html** - 文章详情
4. **about.html** - 关于页
5. **search.html** - 搜索结果
6. **category.html** - 分类文章列表
7. **tag.html** - 标签文章列表
8. **categories.html** - 所有分类

#### 认证模板
9. **login.html** - 登录页
10. **register.html** - 注册页

#### 管理模板
11. **dashboard.html** - 管理后台
12. **edit_post.html** - 编辑文章（含导入按钮）
13. **edit_category.html** - 编辑分类
14. **import.html** - 导入MD页面

### 样式文件

**style.css** - 完整的CSS样式系统
- CSS 变量（颜色、主题）
- 响应式布局
- 夜间模式支持
- 动画效果
- 卡片式设计

## 功能模块详解

### 1. 用户认证
- 密码加密（Werkzeug）
- Session 管理（Flask-Login）
- 登录装饰器保护

### 2. 文章管理
- Markdown 渲染（Python-Markdown）
- 分页显示（Flask-SQLAlchemy）
- 浏览量统计
- 封面图片

### 3. 分类标签
- 多对多关系
- 级联查询
- 统计功能

### 4. 搜索功能
- 全文搜索（LIKE 查询）
- 搜索标题、内容、摘要
- 分页结果

### 5. MD 导入
- 单文件导入
- 批量导入
- 多编码支持（UTF-8、GBK等）
- YAML Front Matter 解析
- 自动提取标题和摘要

### 6. 夜间模式
- CSS 变量切换
- localStorage 保存
- 平滑过渡动画

## 技术栈

| 类别 | 技术 | 版本 |
|------|------|------|
| 后端 | Flask | 3.0.0 |
| ORM | SQLAlchemy | 3.1.1 |
| 认证 | Flask-Login | 0.6.3 |
| 表单 | Flask-WTF | 1.2.1 |
| 数据库 | SQLite | 3 |
| 前端 | Bootstrap | 5.3.0 |
| 图标 | Bootstrap Icons | 1.11.0 |
| Markdown | Python-Markdown | 3.5.1 |

## 安装与启动

### 1. 安装依赖
```bash
cd my-blog
pip install -r requirements.txt
```

### 2. 重置数据库（首次使用）
```bash
python reset_database.py
```

### 3. 启动应用
```bash
python run.py
```

### 4. 访问博客
```
http://localhost:5000
```

## 使用流程

### 首次使用
1. 注册账号：http://localhost:5000/auth/register
2. 登录系统：http://localhost:5000/auth/login
3. 进入管理后台创建分类和标签
4. 发布文章（手动或导入MD）

### 发布文章的三种方式

#### 方式一：手动创建
1. 管理后台 → 新建文章
2. 填写标题、内容、摘要
3. 选择分类、标签
4. 点击保存

#### 方式二：导入MD文件
1. 管理后台 → 导入 MD
2. 选择单个或多个.md文件
3. 点击导入
4. 编辑后发布

#### 方式三：编辑时导入
1. 新建/编辑文章
2. 点击"导入 MD 文件"按钮
3. 选择文件自动填充
4. 补充信息后保存

## 支持的MD格式

### 标准格式
```markdown
# 文章标题

这里是正文...
```

### YAML Front Matter（Jekyll/Hugo）
```markdown
---
title: 文章标题
date: 2025-01-17
---

这里是正文...
```

## 编码支持

自动识别并支持：
- UTF-8（推荐）
- UTF-8 with BOM
- GBK/GB2312（中文）
- ISO-8859-1

## 界面特色

### 设计风格
- 紫色渐变主题（#667eea → #764ba2）
- 卡片式布局
- Material Design 风格
- 流畅动画效果

### 响应式设计
- 移动端适配
- 平板适配
- 桌面端优化

### 交互功能
- 夜间模式切换
- 实时搜索
- 平滑滚动
- 悬停效果

## 常见问题

### 1. 端口被占用
```bash
# Windows
netstat -ano | findstr :5000
taskkill /PID <进程ID> /F

# 或修改 run.py 中的端口
app.run(debug=True, port=5001)
```

### 2. 数据库错误
```bash
python reset_database.py
```

### 3. 模板错误
```bash
python fix_error.py
python run.py
```

### 4. 依赖问题
```bash
pip install -r requirements.txt --force-reinstall
```

## 性能优化建议

### 1. 数据库
- 添加索引（常用字段）
- 使用连接池
- 考虑迁移到 PostgreSQL

### 2. 缓存
- 使用 Redis 缓存
- 缓存热门文章
- 缓存分类标签

### 3. 静态文件
- 使用 CDN
- 启用 gzip 压缩
- 合并 CSS/JS

### 4. 部署
- 使用 Gunicorn
- Nginx 反向代理
- 启用 HTTPS

## 后续开发建议

### 功能扩展
- 评论系统
- 点赞/收藏
- 文章归档
- RSS 订阅
- 友情链接
- 图片上传
- 全文搜索（Elasticsearch）

### 管理功能
- 文章草稿箱
- 回收站
- 批量操作
- 导出备份
- 数据统计

### 用户体验
- 阅读进度
- 代码高亮
- 数学公式（MathJax）
- 流程图（Mermaid）
- 图片懒加载

## 部署到生产环境

### 使用 Gunicorn
```bash
pip install gunicorn
gunicorn -w 4 -b 0.0.0.0:8000 "app:create_app()"
```

### 使用 Nginx
```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /static {
        alias /path/to/my-blog/app/static;
    }
}
```

### 使用 Supervisor
```ini
[program:blog]
command=gunicorn -w 4 "app:create_app()"
directory=/path/to/my-blog
user=www-data
autostart=true
autorestart=true
```

## 项目文件清单（共32个文件）

### 配置文件（5个）
- README.md
- PROJECT_GUIDE.md
- QUICKSTART.md
- TROUBLESHOOTING.md
- requirements.txt

### Python文件（9个）
- run.py
- app/__init__.py
- app/models/user.py
- app/models/post.py
- app/routes/auth.py
- app/routes/main.py
- app/routes/admin.py
- reset_database.py
- migrate_db.py

### 模板文件（14个）
- base.html
- index.html
- post.html
- about.html
- search.html
- category.html
- tag.html
- categories.html
- login.html
- register.html
- dashboard.html
- edit_post.html
- edit_category.html
- import.html

### 静态文件（1个）
- style.css

### 工具脚本（1个）
- fix_error.py

### 测试文件（1个）
- 示例文章.md

### 数据库（1个）
- blog.db

## 当前状态

✅ 所有功能正常
✅ 错误已修复
✅ 应用运行中
✅ 数据库完整

访问地址：**http://localhost:5000**

## 更新日志

### v2.0.0 (2025-01-17)
- 添加分类和标签系统
- 添加MD文件导入功能
- 添加搜索功能
- 添加夜间模式
- 添加浏览量统计
- 修复模板过滤器错误
- 优化数据库结构

### v1.0.0
- 基础博客功能
- 用户认证
- 文章CRUD
- Markdown支持

## 贡献指南

欢迎提交 Issue 和 Pull Request！

## 许可证

MIT License

## 联系方式

- Email: contact@myblog.com
- GitHub: github.com/myblog

---

**享受写作，分享知识！** ✨
